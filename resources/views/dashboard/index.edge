<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Cartographie Kalya</title>
  
  <!-- Tailwind CSS + DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Vis.js pour les graphiques -->
  <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
</head>
<body class="min-h-screen bg-base-200">
  <div class="navbar bg-primary text-primary-content">
    <div class="flex-1">
      <a href="{{ route('dashboard.index') }}" class="btn btn-ghost text-xl">üó∫Ô∏è Cartographie Services</a>
    </div>
    <div class="flex-none">
      <ul class="menu menu-horizontal px-1">
        <li><a href="{{ route('dashboard.index') }}" class="active">Dashboard</a></li>
        <li><a href="{{ route('servers.index') }}">Serveurs</a></li>
        <li><a href="{{ route('services.index') }}">Services</a></li>
        <li>
          <details>
            <summary>{{ user?.fullName || user?.email || 'User' }}</summary>
            <ul class="bg-base-100 rounded-t-none p-2">
              <li><a href="{{ route('auth.logout') }}">D√©connexion</a></li>
            </ul>
          </details>
        </li>
      </ul>
    </div>
  </div>

  <main class="container mx-auto p-4">
    @if(flashMessages.has('success'))
      <div class="alert alert-success mb-4">
        <span>{{ flashMessages.get('success') }}</span>
      </div>
    @endif

    @if(flashMessages.has('error'))
      <div class="alert alert-error mb-4">
        <span>{{ flashMessages.get('error') }}</span>
      </div>
    @endif

    <div class="grid grid-cols-12 gap-4">
      <!-- Sidebar avec infos rapides -->
      <div class="col-span-12 lg:col-span-3">
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title">üìä Statistiques</h2>
            <div class="stats stats-vertical w-full">
              <div class="stat">
                <div class="stat-title">Serveurs</div>
                <div class="stat-value text-primary">{{ servers.length }}</div>
                <div class="stat-actions">
                  <a href="{{ route('servers.index') }}" class="btn btn-sm btn-primary">Voir tout</a>
                </div>
              </div>
              <div class="stat">
                <div class="stat-title">Services</div>
                <div class="stat-value text-secondary">{{ services.length }}</div>
                <div class="stat-actions">
                  <a href="{{ route('services.index') }}" class="btn btn-sm btn-secondary">Voir tout</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- L√©gende -->
        <div class="card bg-base-100 shadow-xl mt-4">
          <div class="card-body">
            <h3 class="card-title text-sm">L√©gende</h3>
            <div class="space-y-2 text-xs">
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-primary rounded"></div>
                <span>Serveurs</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-secondary rounded-full"></div>
                <span>Services</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-8 h-0 border-t-2 border-red-500"></div>
                <span>D√©pendance critique</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="w-8 h-0 border-t-2 border-green-500"></div>
                <span>D√©pendance optionnelle</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Graphique principal -->
      <div class="col-span-12 lg:col-span-9">
        @if(services.length > 0 || servers.length > 0)
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-2">
              <div id="network-container" class="w-full h-96 border border-base-300 rounded"></div>
            </div>
          </div>

          <!-- D√©tails du service s√©lectionn√© -->
          <div id="service-details" class="card bg-base-100 shadow-xl mt-4 hidden">
            <div class="card-body">
              <h3 class="card-title">D√©tails du service</h3>
              <div id="service-content"></div>
            </div>
          </div>
        @else
          <!-- √âtat vide -->
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body text-center">
              <h2 class="card-title justify-center">üó∫Ô∏è Bienvenue dans la cartographie des services !</h2>
              <p class="mb-4">Commencez par ajouter vos premiers serveurs et services pour visualiser votre infrastructure.</p>
              
              <div class="flex flex-col sm:flex-row gap-2 justify-center">
                <a href="{{ route('servers.create') }}" class="btn btn-primary">
                  üñ•Ô∏è Ajouter un serveur
                </a>
                <a href="{{ route('services.create') }}" class="btn btn-secondary">
                  ‚öôÔ∏è Ajouter un service
                </a>
              </div>
              
              <div class="divider">ou</div>
              
              <p class="text-sm text-base-content/70">
                Explorez les sections Serveurs et Services dans le menu de navigation.
              </p>
            </div>
          </div>
        @endif
      </div>
    </div>
  </main>

  @if(services.length > 0 || servers.length > 0)
    <script>
    // Donn√©es du graphique pass√©es depuis le controller
    const graphData = {{{ graphData }}};

    // Configuration Vis.js
    const options = {
      groups: {
        servers: {
          shape: 'box',
          color: { background: '#570df8', border: '#4c0dca' },
          font: { color: 'white' },
          size: 30
        },
        services: {
          shape: 'circle',
          color: { background: '#f000b8', border: '#d1009e' },
          font: { color: 'white' },
          size: 20
        }
      },
      physics: {
        enabled: true,
        stabilization: { iterations: 100 }
      },
      interaction: {
        hover: true,
        selectConnectedEdges: false
      }
    };

    // Cr√©er le r√©seau
    const container = document.getElementById('network-container');
    const network = new vis.Network(container, graphData, options);

    // Event handlers
    network.on("click", function (params) {
      if (params.nodes.length > 0) {
        const nodeId = params.nodes[0];
        if (nodeId.startsWith('service_')) {
          const serviceId = nodeId.replace('service_', '');
          showServiceDetails(serviceId);
        }
      }
    });

    function showServiceDetails(serviceId) {
      // Trouver le service dans les donn√©es
      const serviceNode = graphData.nodes.find(n => n.id === `service_${serviceId}`);
      
      if (serviceNode) {
        const detailsDiv = document.getElementById('service-details');
        const contentDiv = document.getElementById('service-content');
        
        contentDiv.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-bold">Informations g√©n√©rales</h4>
              <p><strong>Nom:</strong> ${serviceNode.label}</p>
              <p><strong>Chemin:</strong> ${serviceNode.path || 'N/A'}</p>
              ${serviceNode.repo_url ? `<p><strong>Repository:</strong> <a href="${serviceNode.repo_url}" target="_blank" class="link">Voir le code</a></p>` : ''}
            </div>
            <div>
              <h4 class="font-bold">Actions</h4>
              <a href="/services/${serviceId}" class="btn btn-primary btn-sm">Voir d√©tails complets</a>
              <a href="/services/${serviceId}/edit" class="btn btn-secondary btn-sm">Modifier</a>
            </div>
          </div>
        `;
        
        detailsDiv.classList.remove('hidden');
      }
    }
    </script>
  @endif
</body>
</html>
